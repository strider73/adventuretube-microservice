pipeline {
    agent {label 'jenkins-agent'}
    stages {
        stage('Run Deployment Script') {
            steps {
                script {
                   sh './adventuretube-cloud-redeploy.sh dev'
                }
            }
        }
        
        stage('Check Docker Container Health') {
            steps {
                script {
                    def services = ["adventuretube-microservice-eureka-service-1",
                                    "adventuretube-microservice-config-server-1",
                                    "adventuretube-microservice-gateway-service-1"]

                    services.each { service ->
                        def serviceReady = false
                        for (int i = 0; i < 10; i++) {
                            def status = sh(
                                script: "docker inspect --format='{{.State.Health.Status}}' ${service} || echo 'unhealthy'",
                                returnStdout: true
                            ).trim()

                            if (status == 'healthy') {
                                serviceReady = true
                                echo "${service} is healthy."
                                break
                            }

                            echo "${service} is not ready yet. Retrying in 5 seconds..."
                            sleep(5)
                        }

                        if (!serviceReady) {
                            error("${service} did not become ready in the expected time")
                        }
                    }
                }
            }
        }
    }
}
